{%- doc -%}
  @description Renders product recommendations.
  
  @param {string} classes - classes to apply to the product recommendations
  @param {string} layout_type - layout type of the product recommendations
  @param {boolean} carousel_on_mobile - whether to show the carousel on mobile
  @param {number} columns_gap - columns gap of the product recommendations
  @param {object} section_settings - section settings

  https://shopify.dev/docs/api/section-rendering-api
{%- enddoc -%}

<script
  src="{{ 'product-recommendations.js' | asset_url }}"
  type="module"
></script>

{% assign block_settings = block.settings %}

{% comment %}
  [data-section-id] {section.id} - used to fetch the product recommendations from the Section Rendering API
{% endcomment %}

<product-recommendations
  id="product-recommendations-{{ block.id }}"
  class="product-recommendations"
  data-url="{{ routes.product_recommendations_url }}?limit={{ block_settings.max_products }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ closest.product.id }}"
  data-intent="{{ block_settings.recommendation_type }}"
  data-recommendations-performed="{{ recommendations.performed }}"
  {% if request.visual_preview_mode %}
    data-shopify-editor-preview
  {% endif %}
  data-testid="product-recommendations-block"
  {{ block.shopify_attributes }}
>
  {%- if recommendations.performed or closest.product == blank -%}
    {% liquid
      assign products = recommendations.products

      if closest.product == blank
        # Onboarding mode: Show placeholder products
        for i in (1..block_settings.max_products)
          assign products = products | append: ', '
          assign products = products | split: ','
        endfor
      elsif recommendations.performed and recommendations.products_count == 0
        # No recommendations found, pull from catalog
        if block_settings.recommendation_type == 'related'
          assign products = collections.all.products | reject: 'id', closest.product.id
        elsif block_settings.recommendation_type == 'complementary'
          # Do not recommend the All collection as complementary products
          assign products = null
        endif
      else
        assign products = recommendations.products
      endif
    %}
    {% capture list_items %}
        {% for product in products limit: block_settings.max_products %}
          <div class="resource-list__item">
            {% content_for 'block',
              type: '_product-card',
              id: 'static-product-card',
              closest.product: product
            %}
          </div>
          {% if layout_type == 'carousel' or carousel_on_mobile %}
            {% unless forloop.last %}
              <!--@list/split-->
            {% endunless %}
          {% endif %}
        {% endfor %}
      {% endcapture %}

    {% liquid
      # Create an array from the list items to be used in the carousel
      assign slide_content = list_items | strip
      assign slides = slide_content | split: '<!--@list/split-->'

      if products != blank and products.size > 0
        assign has_recommendations = 'true'
      else
        assign has_recommendations = 'false'
      endif
    %}

    <div
      class="
        resource-list
        {% if carousel_on_mobile and layout_type != 'carousel' %}
          hidden--mobile
        {% endif %}
        {{ classes }}
      "
      {% if layout_type == 'grid' %}
        data-testid="resource-list-grid"
      {% endif %}
      data-has-recommendations="{{ has_recommendations }}"
    >
      {% case layout_type %}
        {% when 'grid' %}
          {{ list_items }}
        {% when 'carousel' %}
          {% render 'resource-list-carousel',
            ref: 'resourceListCarousel',
            slides: slides,
            slide_count: recommendations.products.size,
            settings: section_settings
          %}
      {% endcase %}
    </div>

    {% if carousel_on_mobile and layout_type != 'carousel' %}
      {% liquid
        assign mobile_carousel_gap = columns_gap
      %}
      <div
        class="
          resource-list
          hidden--desktop
          force-full-width
        "
        style="--resource-list-gap: {{ mobile_carousel_gap }}px;"
      >
        {% render 'resource-list-carousel',
          ref: 'resourceListCarouselMobile',
          slides: slides,
          slide_count: recommendations.products.size,
          settings: section_settings
        %}
      </div>
    {% endif %}
  {%- else -%}
    <div class="resource-list resource-list--grid">
      {% for i in (1..block_settings.max_products) %}
        <div
          class="resource-list__item product-recommendations__skeleton-item"
          aria-label="{{ 'accessibility.loading_product_recommendations' | t }}"
        ></div>
      {% endfor %}
    </div>
  {%- endif -%}
</product-recommendations>

{% stylesheet %}
  .product-recommendations-wrapper {
    width: 100%;
  }

  .product-recommendations-wrapper:has(product-recommendations[data-shopify-editor-preview]) {
    width: 100vw;
  }

  .product-recommendations {
    display: block;
  }

  .block-resource-list {
    border-radius: var(--border-radius, 0);
  }

  .product-recommendations__skeleton-item {
    aspect-ratio: 3 / 4;
    background-color: var(--color-foreground);
    opacity: var(--skeleton-opacity);
    border-radius: 4px;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_recommendations",
  "class": "product-recommendations-wrapper",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product_recommendations"
    },
    {
      "type": "select",
      "id": "recommendation_type",
      "label": "t:settings.type",
      "options": [
        {
          "value": "related",
          "label": "t:options.related"
        },
        {
          "value": "complementary",
          "label": "t:options.complementary"
        }
      ],
      "default": "related"
    },
    {
      "type": "paragraph",
      "content": "t:content.complementary_products"
    },
    {
      "type": "header",
      "content": "t:content.cards_layout"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "t:settings.product_count",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "t:names.product_recommendations",
      "category": "t:categories.product",
      "settings": {
        "recommendation_type": "related",
      },
      "blocks": {
        "static-product-card": {
          "type": "_product-card",
          "static": true,
          "settings": {
            "product_card_gap": 4
          },
          "blocks": {
            "product-card-gallery": {
              "type": "_product-card-gallery",
              "settings": {
                "image_ratio": "adapt",
                "border": "none",
                "border_width": 1,
                "border_opacity": 100,
                "border_radius": 0,
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "product_title": {
              "type": "product-title",
              "name": "t:names.product_title",
              "settings": {
                "width": "fit-content",
                "max_width": "normal",
                "alignment": "left",
                "type_preset": "rte",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "wrap": "pretty",
                "color": "var(--color-foreground)",
                "background": false,
                "background_color": "#00000026",
                "corner_radius": 0,
                "padding-block-start": 4,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "price": {
              "type": "price",
              "name": "t:names.product_price",
              "settings": {
                "show_sale_price_first": true,
                "show_installments": false,
                "show_tax_info": false,
                "type_preset": "h6",
                "width": "100%",
                "alignment": "left",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "color": "var(--color-foreground)",
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            }
          },
          "block_order": ["product-card-gallery", "product_title", "price"]
        }
      }
    }
  ]
}
{% endschema %}
